#
# mods_download.yml - Load a minetest mod from the internet and place it correctly into the minetest installation
#
# 2020-02-21 created by selfscrum 
# 
---

- name: Download "{{module}}" from github
  get_url: 
    url: "https://github.com/{{module_path}}/archive/master.zip"
    dest: /tmp/master.zip
  when: src|default('github') == 'github'

- name: Download "{{module}}" from ContentDB
  block:
    - name: Get file location from ContentDB
      uri: 
        url: "https://content.minetest.net/packages/{{module_path}}/download"
        dest: /tmp/master.zip
        status_code: 300
      register: uri_asset

    - name: Donwload redirected file
      get_url: 
        url: "{{ uri_asset.location }}"
        dest: /tmp/master.zip
  when: src|default('github') == 'ContentDB'

- name: Unzip the Download
  unarchive:
    src: /tmp/master.zip
    dest: "{{ lookup('env','MT_DISK') }}/mods"
    owner: minetest
    group: minetest
    remote_src: true

- name: Move the Mod
  block: 
  - name: Stat the original Direcory
    stat: 
      path: "{{ lookup('env','MT_DISK') }}/mods/{{module}}-master"
    register: master_mod

  - name: Move
    command: "mv {{ lookup('env','MT_DISK') }}/mods/{{module}}-master {{ lookup('env','MT_DISK') }}/mods/{{module}}"
    when: master_mod.stat.exists
    
  when: move|default('false')

- name: Add Config Line for "{{module}}" in world.mt
  lineinfile:
    path: "{{ lookup('env','MT_DISK') }}/data/world.mt"
    regexp: "^load_mod_{{item}} ="
    line: "load_mod_{{item}} = true"
  loop: "{{ load_mods | default( [ module ] ) }}"
  notify: "Restart Minetest Service"

- name: Add Config Line for "{{module}}" in minetest.conf
  lineinfile:
    path: "{{ lookup('env','MT_DISK') }}/conf/minetest.conf"
    regexp: "^{{item}}"
    line: "{{item}}"
  loop: "{{load_conf | default([])}}"
  notify: "Restart Minetest Service"
